name: Docker Image CI

on:
  push:
    branches: [ "master" ]

jobs:

  pipeline-job:

    runs-on: ubuntu-latest
    env:
      PROJECT_DIR: app-1
    steps:
    - uses: actions/checkout@v2

    # - name: Docker in Docker
    #   run: |
    #     curl -fsSL get.docker.com | sh

    - name: Import environment variables from a file
      run: |
        cat ./app-1/.env >> $GITHUB_ENV

    # - name: Ci
    #   run: |
    #     ./agnostic-pipeline/stages/01_ci.sh

    # - name: Build
    #   run: |
    #     ./agnostic-pipeline/stages/02_build.sh

    # - name: Test
    #   run: |
    #     ./agnostic-pipeline/stages/03_test.sh

    # - name: Archive
    #   run: |
    #     export DOCKER_PASSWORD="${{secrets.DOCKER_PASSWORD}}"
    #     ./agnostic-pipeline/stages/04_archive.sh

    # - name: Pre-deploy
    #   id: pre-deploy
    #   uses: andstor/file-reader-action@v1
    #   with:
    #     path: ./agnostic-pipeline/stages/05_deploy.sh




    - name: Deploy
      env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p $DEPLOY_PORT -t rsa $DEPLOY_HOST >> ~/.ssh/known_hosts
        ssh-agent -a $SSH_AUTH_SOCK > /dev/null
        ssh-add - <<< "${{ secrets.SSH_PRIVATE_KEY }}"
        ./agnostic-pipeline/stages/05_deploy.sh



    